// Generated by sonos-docs, do not edit.

use rupnp::{Device, Service};
use rupnp::http::Uri;
use rupnp::ssdp::URN;use crate::sonos::gen::errors::Error;

/// Sonos {{serviceName}}
///
{{#if description}}
/// {{{description}}}
{{/if}}
#[derive(Debug)]
pub struct {{serviceName}} {
    service: Service,
    url: Uri,
}

impl {{serviceName}} {
    /// Create a new {{serviceName}} instance from an existing UPnP device.
    pub async fn from_device(device: Device) -> Option<Self> {
        let urn = "{{serviceType}}".parse::<URN>().unwrap();
        if let Some(s) = device.find_service(&urn) {
            Some(Self{ service: s.clone(), url: device.url().clone() })
        } else {
            None
        }
    }

    {{#each actions}}
    /// {{name}}
    {{#if description}}
    ///
    /// {{{description}}}
    {{/if}}
    {{#if remarks}}
    ///
    /// Note: {{{remarks}}}
    {{/if}}
    {{#if inputs}}
    ///
    /// Parameters:
    {{#each inputs}}
    /// * `{{snake name}}`{{#if description}} : {{{description}}}{{/if}}
    {{/each}}
    {{/if}}
    {{#if outputs}}
    ///
    /// Outputs:
    {{#each outputs}}
    /// * `{{snake name}}`{{#if description}} : {{{description}}}{{/if}}
    {{/each}}
    {{/if}}
    pub async fn {{snake name}}(
            &self,
            {{#each inputs}}
            {{snake name}}: {{relatedStateVariable.dataType}}{{#unless @last}},{{/unless}}
            {{/each}}
        ) -> Result<{{#if outputs}}{{name}}Result{{else}}(){{/if}}, Error> {
        {{#if inputs}}
        // TODO: use xml helper
        let mut payload = String::new();
        {{#each inputs}}
        payload.push_str(format!("<{{name}}>{}</{{name}}>", {{snake name}}).as_str());
        {{/each}}
        {{else}}
        let payload = String::new();
        {{/if}}
        {{#if outputs}}let response = {{/if}}self.service.action(&self.url, "SetTimeNow", payload.as_str()).await?;
        {{#if outputs}}
        // TODO: map parse errors
        Ok({{name}}Result {
            {{#each outputs}}
            {{snake name}}: response.get("{{name}}").ok_or_else(|| Error::MissingField("{{name}}".to_string()))?
                .parse().map_err(|_| Error::ParseError("{{name}}".to_string()))?,
            {{/each}}
        })
        {{else}}
        Ok(())
        {{/if}}
    }
    {{#unless @last}}

    {{/unless}}
    {{/each}}
}

{{#each actions}}
{{#if outputs}}
#[derive(Debug)]
pub struct {{name}}Result {
    {{#each outputs}}
    {{#if description}}
    /// {{{description}}}
    {{/if}}
    pub {{snake name}}: {{relatedStateVariable.dataType}},
    {{/each}}
}
{{#unless @last}}

{{/unless}}
{{/if}}
{{/each}}
